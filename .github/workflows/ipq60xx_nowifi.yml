#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-bulder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: "SSH Connection to Actions"
        required: false
        default: false
  schedule:
    - cron: '0 20 1 * *'

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss
  WORKING_DIR: openwrt
  CONFIG_FILE: configs/ipq60xx_nowifi.config
  SCRIPT_PACKAGES: scripts/packages.sh
  SCRIPT_SETTINGS: scripts/settings.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  FIRMWARE_TAG: ipq60xx-nowifi-6.12-nss
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@main
      
    - name: Check Server Info.
      run: |
        echo "Physical CPU Number: $(cat /proc/cpuinfo | grep 'physical id' | sort | uniq | wc -l)"
        echo -e "CPU Model: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
        echo "RAM Info:"
        echo -e "$(sudo lshw -short -C memory | grep GiB)"
        echo "Disk Info: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
      
    - name: Initialize Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo docker image prune --all --force
        sudo -E apt -yqq purge firefox
        sudo -E apt -yqq update
        sudo -E apt -yqq full-upgrade
        sudo -E apt -yqq autoremove --purge
        sudo -E apt -yqq autoclean
        sudo -E apt -yqq clean
        sudo -E apt -yqq install dos2unix libfuse-dev python3-setuptools
        sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"

    - name: Clone Source Code
      run: |
        sudo mkdir -p /mnt/$WORKING_DIR
        sudo chown $USER:$USER /mnt/$WORKING_DIR
        sudo ln -s /mnt/$WORKING_DIR $GITHUB_WORKSPACE/$WORKING_DIR
        
        df -hT $GITHUB_WORKSPACE
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL $WORKING_DIR
        find ./ -maxdepth 3 -type f -iname "*.sh" -exec dos2unix {} \; -exec chmod +x {} \;
    
    - name: Initialize Values
      run: |
        echo "OPENWRT_BUILD_DATE=$(TZ=UTC-8 date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "OPENWRT_DEVICE_TARGET=$(grep -m 1 -oP '^CONFIG_TARGET_\K[\w]+(?=\=y)' $CONFIG_FILE)" >> $GITHUB_ENV
        echo "OPENWRT_PATH=$GITHUB_WORKSPACE/$WORKING_DIR" >> $GITHUB_ENV

    #- name: SSH connection to Actions
    #  uses: P3TERX/ssh2actions@main
    #  if: github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh')
    #  env:
    #    TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    #    TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    - name: Load Custom Feeds & Packages
      run: |
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/$SCRIPT_PACKAGES

    - name: Check Caches
      uses: actions/cache@main
      with:
        key: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.OPENWRT_DEVICE_TARGET }}-${{ env.OPENWRT_BUILD_DATE }}
        restore-keys: ${{ env.REPO_URL }}-${{ env.REPO_BRANCH }}-${{ env.OPENWRT_DEVICE_TARGET }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir/host*
          ${{ env.OPENWRT_PATH }}/staging_dir/tool*

    - name: Update Caches
      run: |
        if [ -d "$OPENWRT_PATH/staging_dir" ]; then
          find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
              find "$dir" -type f -exec touch {} +
          done
        fi

    - name: Install Feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@main
      if: github.event.inputs.ssh == 'true' || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  
    - name: Load Custom Configurations
      run: |
        [ -e files ] && mv files $OPENWRT_PATH/files
        [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cat $GITHUB_WORKSPACE/$CONFIG_FILE >> $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/$SCRIPT_SETTINGS

    - name: Download Packages
      run: |
        cd $OPENWRT_PATH
        make defconfig
        make download -j$(nproc)
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile Firmware
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Check Space Usage
      if: (!cancelled())
      run: df -hT

    - name: Upload Bin Directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: OpenWrt_bin_${{ env.OPENWRT_DEVICE_TARGET }}_${{ env.OPENWRT_BUILD_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: Organize Files
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd $OPENWRT_PATH && mkdir -p $OPENWRT_PATH/upload
        cp $OPENWRT_PATH/.config ${{ env.FIRMWARE_TAG }}.config
        echo "OPENWRT_VERSION_KERNEL=$(find $OPENWRT_PATH/bin/targets/ -type f -name "*.manifest" -exec grep -oP '^kernel - \K[\d\.]+' {} \;)" >> $GITHUB_ENV
        
        find $OPENWRT_PATH/bin/targets/ -iregex ".*\(buildinfo\|json\|sha256sums\|packages\)$" -exec rm -rf {} +
        find $OPENWRT_PATH/bin/targets/ -type f -exec mv -f {} $OPENWRT_PATH/upload/ \;
        echo "OPENWRT_FIRMWARE_PATH=$OPENWRT_PATH/upload" >> $GITHUB_ENV

    - name: Upload Firmware Directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled() 
      with:
        name: OpenWrt_firmware_${{ env.OPENWRT_DEVICE_TARGET }}_${{ env.OPENWRT_BUILD_DATE }}
        path: ${{ env.OPENWRT_FIRMWARE_PATH }}

    - name: Upload Firmware To Release
      uses: ncipollo/release-action@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled() 
      with:
        name: ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.OPENWRT_FIRMWARE_PATH }}/*
        body: |
          This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}
          - Source Code: ${{ env.REPO_URL }}
          - Branch: ${{ env.REPO_BRANCH }}
          - Default Login Address：192.168.50.1
          - Firmware Kernel：${{ env.OPENWRT_VERSION_KERNEL }}
        
    - name: Delete Workflow Runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 3

    - name: Remove Old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
